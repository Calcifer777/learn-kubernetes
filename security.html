

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Security &mdash; Kubernetes Notes 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Storage" href="storage.html" />
    <link rel="prev" title="Logging and Monitoring" href="logging-and-monitoring.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Kubernetes Notes
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="cluster-setup.html">Cluster setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="cluster-maintenance.html">Cluster Maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="pods.html">Pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="workloads.html">Workloads</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheduling.html">Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="iam.html">IAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging-and-monitoring.html">Logging and Monitoring</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Security</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#authentication-modes">Authentication Modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#authentication">Authentication</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#static-password-file">Static password file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#static-token-file">Static token file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#certificates">Certificates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#identity-services">Identity services</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tls">TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rbac">RBAC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#roles">Roles</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#service-accounts">Service Accounts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Resources</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#kube-config">Kube-config</a></li>
<li class="toctree-l2"><a class="reference internal" href="#network-policies">Network policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exercises">Exercises</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#inspect-a-certificate">Inspect a certificate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generate-the-certificates-for-the-cluster">Generate the certificates for the cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-new-user-approve-csr">Create a new user, approve CSR</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-an-user-private-key-and-csr">Create an user private key and csr</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-a-csr-k8s-object">Create a csr K8s object</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#inspect-the-kubeconfig-file">Inspect the kubeconfig file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-images-from-private-registry">Use images from private registry</a></li>
<li class="toctree-l3"><a class="reference internal" href="#set-containers-security-context-properties">Set containers security context properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="#useful-commands">Useful commands</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="storage.html">Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="todos.html">TODO’s</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Kubernetes Notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Security</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/security.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="security">
<h1>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h1>
<div class="section" id="authentication-modes">
<h2>Authentication Modes<a class="headerlink" href="#authentication-modes" title="Permalink to this headline">¶</a></h2>
<p>The Kubernetes API server may authorize a request using one of several authorization modes:</p>
<ul class="simple">
<li><p>Node: A special-purpose authorization mode that grants permissions to kubelets based on the pods they are scheduled to run</p></li>
<li><p>Attribute-based access control - ABAC: defines an access control paradigm whereby access rights are granted to users through the use of policies which combine attributes together. The policies can use any type of attributes (user attributes, resource attributes, object, environment attributes, etc). ABAC vs RBAC: <a class="reference external" href="https://www.dnsstuff.com/rbac-vs-abac-access-control">https://www.dnsstuff.com/rbac-vs-abac-access-control</a></p></li>
<li><p>Role-based access control (RBAC): is a method of regulating access to resources based on the roles of individual users within an enterprise. In this context, access is the ability of an individual user to perform a specific task, such as view, create, or modify a file.</p></li>
<li><p>Webhook: a WebHook is an HTTP callback: an HTTP POST that occurs when something happens; a simple event-notification via HTTP POST. A web application implementing WebHooks will POST a message to a URL when certain things happen.</p></li>
</ul>
</div>
<div class="section" id="authentication">
<h2>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h2>
<p>All user access is managed by the <cite>kube-apiserver</cite>.</p>
<div class="section" id="static-password-file">
<h3>Static password file<a class="headerlink" href="#static-password-file" title="Permalink to this headline">¶</a></h3>
<p>A static file with the users’ username and password credentials.</p>
<p>The credential file must be passed as an argument to the <cite>kube-apiserver</cite>, or as a Pod argument in the case of <cite>kubeadm</cite>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-apiserver</span>
<span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="nt">containers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-apiserver</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">k8s.gcr.io/kube-apiserver-amd64:v1.11.3</span>
    <span class="nt">command</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">kube-apiserver</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--authorization-mode=Node,RBAC</span>
        <span class="l l-Scalar l-Scalar-Plain">...</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--basic-auth-file=/tmp/users/user-details.csv</span>   <span class="c1"># &lt;- relevant argument</span>
    <span class="nt">volumeMounts</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/users</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">usr-details</span>
        <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">volumes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">hostPath</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/users</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DirectoryOrCreate</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">usr-details</span>
</pre></div>
</div>
<p>Then, for each user, create the necessary roles and role-bindings.</p>
</div>
<div class="section" id="static-token-file">
<h3>Static token file<a class="headerlink" href="#static-token-file" title="Permalink to this headline">¶</a></h3>
<p>Same as the static password file, but with tokens instead of passwords</p>
</div>
<div class="section" id="certificates">
<h3>Certificates<a class="headerlink" href="#certificates" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="identity-services">
<h3>Identity services<a class="headerlink" href="#identity-services" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="tls">
<h2>TLS<a class="headerlink" href="#tls" title="Permalink to this headline">¶</a></h2>
<p>Types of certificates:</p>
<ul class="simple">
<li><p>certificate authority (ca)</p></li>
<li><p>server certificate</p></li>
<li><p>client certificate</p></li>
</ul>
<p>Components that use a certificate:</p>
<ul class="simple">
<li><p>server
- kube-api server
- etcd
- kubelet</p></li>
<li><p>client
- admin
- scheduler
- kube-controller manager
- kube-proxy
- kube-api server (when communicating with the etcd, or the kubelet)
- kubelet client</p></li>
</ul>
</div>
<div class="section" id="rbac">
<h2>RBAC<a class="headerlink" href="#rbac" title="Permalink to this headline">¶</a></h2>
<div class="section" id="roles">
<h3>Roles<a class="headerlink" href="#roles" title="Permalink to this headline">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pod-reader</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">apiGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>                               <span class="c1"># &quot;&quot; indicates the core API group</span>
  <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;pods&quot;</span><span class="p p-Indicator">]</span>
  <span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;list&quot;</span><span class="p p-Indicator">]</span>

<span class="nn">---</span>

<span class="c1"># This role binding allows &quot;jane&quot; to read pods in the &quot;default&quot; namespace.</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">read-pods</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">subjects</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">User</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">user1</span>                                   <span class="c1"># Name is case sensitive</span>
  <span class="nt">apiGroup</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class="nt">roleRef</span><span class="p">:</span>
  <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Role</span>                                    <span class="c1"># This must be Role or ClusterRole</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pod-reader</span>                              <span class="c1"># must match the name of the Role to which to bind</span>
  <span class="nt">apiGroup</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</pre></div>
</div>
<div class="section" id="resources">
<h4>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb">Requests Verbs Docs</a></p>
</div>
</div>
<div class="section" id="service-accounts">
<h3>Service Accounts<a class="headerlink" href="#service-accounts" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl create sa &lt;service-account-name&gt;
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;service-account-name&gt;</span>
<span class="nt">secrets</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;service-account-name&gt;-token-f9gcv</span>
</pre></div>
</div>
<div class="section" id="id1">
<h4>Resources<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://mjarosie.github.io/dev/2021/09/15/iam-roles-for-kubernetes-service-accounts-deep-dive.html">https://mjarosie.github.io/dev/2021/09/15/iam-roles-for-kubernetes-service-accounts-deep-dive.html</a></p>
</div>
</div>
</div>
<div class="section" id="kube-config">
<h2>Kube-config<a class="headerlink" href="#kube-config" title="Permalink to this headline">¶</a></h2>
<p>A <cite>~/.kube/config</cite> file defines:
- a set of clusters
- a set of users
- a set of contexts; a context defines which user to use for logging in to a cluster</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Config</span>
<span class="nt">clusters</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-first-cluster</span>
  <span class="nt">cluster</span><span class="p">:</span>
    <span class="nt">certificate-authority</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">path/to/cert.crt</span>
    <span class="nt">server</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://ip-of-the-cluster:port</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">users</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-user</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">contexts</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-user@my-first-cluster</span>
  <span class="nt">context</span><span class="p">:</span>
    <span class="nt">cluster</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-first-cluster</span>
    <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-user</span>
    <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-first-cluster</span>
<span class="nt">current-context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-user@my-first-cluster</span>
</pre></div>
</div>
</div>
<div class="section" id="network-policies">
<h2>Network policies<a class="headerlink" href="#network-policies" title="Permalink to this headline">¶</a></h2>
<p>NetworkPolicies allow to specify how a <cite>Pod</cite> is allowed to communicate with various network “entities”.  These entities are identified through a combination of the following 3 identifiers:</p>
<ul class="simple">
<li><p>Other pods that are allowed</p></li>
<li><p>Namespaces that are allowed</p></li>
<li><p>IP blocks</p></li>
</ul>
<p>Once there is any <cite>NetworkPolicy</cite> in a namespace selecting a particular <cite>Pod</cite>, that <cite>Pod</cite> will reject any connections that are not allowed by any <cite>NetworkPolicy</cite>.</p>
<p>Network policies are implemented by the network plugin. To use network policies, you must be using a networking solution which supports <cite>NetworkPolicy</cite>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test-network-policy</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">podSelector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">db</span>                  <span class="c1"># which Pods the NetworkPolicy applies</span>
  <span class="nt">policyTypes</span><span class="p">:</span>                  <span class="c1"># which type of effects the NetworkPolicy will have</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Egress</span>
  <span class="nt">ingress</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">from</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">podSelector</span><span class="p">:</span>              <span class="c1"># allow FROM Pods with given attributes</span>
        <span class="nt">matchLabels</span><span class="p">:</span>
          <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
    <span class="p p-Indicator">-</span> <span class="nt">ipBlock</span><span class="p">:</span>                  <span class="c1"># allow FROM specific CIDR blocks</span>
        <span class="nt">cidr</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">172.17.0.0/16</span>
        <span class="nt">except</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">172.17.1.0/24</span>
    <span class="nt">ports</span><span class="p">:</span>                      <span class="c1"># specify the type of traffic</span>
    <span class="p p-Indicator">-</span> <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">6379</span>
  <span class="nt">egress</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">to</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">namespaceSelector</span><span class="p">:</span>        <span class="c1"># allow TO a namespace</span>
        <span class="nt">matchLabels</span><span class="p">:</span>
          <span class="nt">project</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myproject</span>
    <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5978</span>
</pre></div>
</div>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<div class="section" id="inspect-a-certificate">
<h3>Inspect a certificate<a class="headerlink" href="#inspect-a-certificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>openssl x509 -in &lt;file-path.crt&gt; -text -noout
</pre></div>
</div>
</div>
<div class="section" id="generate-the-certificates-for-the-cluster">
<h3>Generate the certificates for the cluster<a class="headerlink" href="#generate-the-certificates-for-the-cluster" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the ca certificate</span>
open genrsa -out ca.key <span class="m">2048</span>  <span class="c1"># generate the key</span>
openssl req -new -key ca.key -subj <span class="s2">&quot;/CN=KUBERNETES-CA&quot;</span> -out ca.csr                    <span class="c1"># generate the certificate sign request</span>
openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt                              <span class="c1"># sign the certificate</span>

<span class="c1"># Create the client certificate (example for the admin user):</span>

open genrsa -out admin.key <span class="m">2048</span>                                                       <span class="c1"># generate the key</span>
openssl req -new -key admin.key -subj <span class="s2">&quot;/CN=kube-admin/O=system:masters&quot;</span> -out ca.csr   <span class="c1"># generate the certificate sign request</span>
openssl x509 -req -in admin.csr -signkey -CA ca.crt -CAkey ca.key -out admin.crt      <span class="c1"># sign the certificate with the ca certificate</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-new-user-approve-csr">
<h3>Create a new user, approve CSR<a class="headerlink" href="#create-a-new-user-approve-csr" title="Permalink to this headline">¶</a></h3>
<div class="section" id="create-an-user-private-key-and-csr">
<h4>Create an user private key and csr<a class="headerlink" href="#create-an-user-private-key-and-csr" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>openssl genrsa -out user-name.key <span class="m">2048</span>
openssl req -new -key user-name.key -subj <span class="s2">&quot;/CN=user-name&quot;</span> -out user-name.csr
</pre></div>
</div>
</div>
<div class="section" id="create-a-csr-k8s-object">
<h4>Create a csr K8s object<a class="headerlink" href="#create-a-csr-k8s-object" title="Permalink to this headline">¶</a></h4>
<p>Print the base64 encoded CSR in one line</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat user-name.csr <span class="p">|</span> base64 <span class="p">|</span> tr -d <span class="s1">&#39;\n&#39;</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">certificates.k8s.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CertificateSigningRequest</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">user-name</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">signerName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kubernetes.ui/kube-apiserver-client</span>
  <span class="nt">groups</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">system:authenticated</span>
  <span class="nt">usages</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">client auth</span>
<span class="nt">requests</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;paste-base64-encoded-csr-content&gt;</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl certificate approve<span class="p">|</span>deny user-name
</pre></div>
</div>
</div>
</div>
<div class="section" id="inspect-the-kubeconfig-file">
<h3>Inspect the kubeconfig file<a class="headerlink" href="#inspect-the-kubeconfig-file" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl config view --kubeconfig &lt;path-to-config-file&gt;
</pre></div>
</div>
</div>
<div class="section" id="use-images-from-private-registry">
<h3>Use images from private registry<a class="headerlink" href="#use-images-from-private-registry" title="Permalink to this headline">¶</a></h3>
<p>Create a secret with the credentials to the private repository</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl create secret docker-registry &lt;docker-registry-secret-name&gt;  <span class="se">\ </span>  <span class="c1"># use this in the next step</span>
  --docker-username<span class="o">=</span>user  <span class="se">\</span>
  --docker-password<span class="o">=</span>password  <span class="se">\</span>
  --docker-email<span class="o">=</span>email  <span class="se">\</span>
  --docker-server<span class="o">=</span>string
</pre></div>
</div>
<p>Edit the corresponding entry in the <cite>Pod</cite> definition</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">...</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">imagePullSecrets</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker-registry-secret-name</span>
  <span class="nt">containers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
</div>
<div class="section" id="set-containers-security-context-properties">
<h3>Set containers security context properties<a class="headerlink" href="#set-containers-security-context-properties" title="Permalink to this headline">¶</a></h3>
<p>You can set the security context at the Pod level or at the container level. Specifications at the container level overwrite those at the <cite>Pod</cite> level.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">...</span>
<span class="nt">securityContext</span><span class="p">:</span>
  <span class="nt">runAsUser</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-user</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">containers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">securityContext</span>
      <span class="l l-Scalar l-Scalar-Plain">runAsUser</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-other-user</span>  <span class="c1"># this has precedence over the Pod level specification</span>
      <span class="nt">capabilities</span><span class="p">:</span>
        <span class="nt">add</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SYS_TIME</span>
</pre></div>
</div>
</div>
<div class="section" id="useful-commands">
<h3>Useful commands<a class="headerlink" href="#useful-commands" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl api-resources  <span class="c1"># display all Kubernetes resource types</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="storage.html" class="btn btn-neutral float-right" title="Storage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="logging-and-monitoring.html" class="btn btn-neutral float-left" title="Logging and Monitoring" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Marco Filippone.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>